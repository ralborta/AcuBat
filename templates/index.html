<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcuBat - Sistema de Pricing Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background: #e9ecef;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        .conversion-progress {
            display: none;
            margin-top: 20px;
        }
        .pdf-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
            margin-top: 10px;
        }
        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn-convert {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        .btn-convert:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar izquierdo -->
            <div class="col-md-3 bg-light p-4 min-vh-100">
                <h4 class="mb-4">
                    <i class="fas fa-chart-line text-primary"></i>
                    Rating: Calificación
                </h4>
                
                <div class="stats-card">
                    <h2 class="display-4 text-center">{{ total_productos }}</h2>
                    <p class="text-center mb-0">Productos Cargados</p>
                </div>

                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h2 class="display-4 text-center">{{ productos_con_alertas }}</h2>
                    <p class="text-center mb-0">Con Alertas</p>
                </div>

                <div class="mt-4">
                    <h5><i class="fas fa-filter text-info"></i> Filtros</h5>
                    <select id="filtroCanal" class="form-select mb-2">
                        <option value="">Todos los canales</option>
                        {% for canal in resumen_canales.keys() %}
                        <option value="{{ canal }}">{{ canal }}</option>
                        {% endfor %}
                    </select>
                    
                    <select id="filtroMarca" class="form-select mb-2">
                        <option value="">Todas las marcas</option>
                        {% for marca in resumen_marcas.keys() %}
                        <option value="{{ marca }}">{{ marca }}</option>
                        {% endfor %}
                    </select>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filtroAlertas">
                        <label class="form-check-label" for="filtroAlertas">
                            Solo con alertas
                        </label>
                    </div>
                </div>

                <div class="mt-4">
                    <button class="btn btn-success w-100 mb-2" onclick="exportarCSV()">
                        <i class="fas fa-download"></i> Exportar CSV
                    </button>
                    
                    {% if openai_disponible %}
                    <button class="btn btn-primary w-100 mb-2" onclick="analizarOpenAI()">
                        <i class="fas fa-brain"></i> Analizar con IA
                    </button>
                    {% else %}
                    <div class="alert alert-warning alert-sm">
                        <i class="fas fa-exclamation-triangle"></i>
                        OpenAI no disponible
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Contenido principal -->
            <div class="col-md-9 p-4">
                <h1 class="mb-4">
                    <i class="fas fa-rocket text-primary"></i>
                    AcuBat - Sistema de Pricing Inteligente
                </h1>

                <!-- Área de carga de archivos -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cloud-upload-alt text-primary"></i>
                            Cargar Lista de Precios
                        </h5>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Arrastra tu archivo aquí</h5>
                            <p class="text-muted">Soporta Excel (.xlsx, .xls), CSV (.csv) y PDF (.pdf)</p>
                            <button class="btn btn-primary">
                                <i class="fas fa-file-upload"></i>
                                Seleccionar Archivo
                            </button>
                        </div>

                        <!-- Conversión en línea de PDF -->
                        <div id="pdfConversion" class="conversion-progress">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-cog fa-spin"></i> Convirtiendo PDF a Excel...</h6>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">Procesando página <span id="currentPage">1</span> de <span id="totalPages">?</span></small>
                            </div>
                        </div>

                        <!-- Vista previa de PDF -->
                        <div id="pdfPreview" class="pdf-preview" style="display: none;">
                            <h6><i class="fas fa-eye"></i> Vista Previa del PDF</h6>
                            <div id="pdfContent"></div>
                            <button class="btn btn-convert mt-2" onclick="convertirPDFaExcel()">
                                <i class="fas fa-magic"></i> Convertir a Excel
                            </button>
                        </div>

                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.pdf" style="display: none;">
                    </div>
                </div>

                <!-- Resultados -->
                {% if productos %}
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-list text-success"></i> Productos Procesados</h4>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="limpiarProductos()">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th>Marca</th>
                                    <th>Canal</th>
                                    <th>Precio Base</th>
                                    <th>Precio Final</th>
                                    <th>Margen</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="productosTable">
                                {% for producto in productos %}
                                <tr class="producto-row" 
                                    data-canal="{{ producto.canal }}" 
                                    data-marca="{{ producto.marca }}"
                                    data-alertas="{{ 'true' if producto.alertas else 'false' }}">
                                    <td>{{ producto.nombre }}</td>
                                    <td>{{ producto.marca }}</td>
                                    <td>{{ producto.canal }}</td>
                                    <td>${{ "%.2f"|format(producto.precio_base) }}</td>
                                    <td>${{ "%.2f"|format(producto.precio_final) }}</td>
                                    <td>{{ "%.1f"|format(producto.margen) }}%</td>
                                    <td>
                                        {% if producto.alertas %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Alerta
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i>
                                            OK
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfData = null;
        let currentFile = null;

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            currentFile = file;
            
            if (file.type === 'application/pdf') {
                // Procesar PDF en línea
                procesarPDFEnLinea(file);
            } else {
                // Subir archivo normal
                subirArchivo(file);
            }
        }

        async function procesarPDFEnLinea(file) {
            try {
                // Mostrar progreso
                document.getElementById('pdfConversion').style.display = 'block';
                const progressBar = document.querySelector('.progress-bar');
                
                // Leer PDF
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                
                document.getElementById('totalPages').textContent = pdf.numPages;
                
                let extractedText = '';
                
                // Extraer texto de cada página
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    document.getElementById('currentPage').textContent = pageNum;
                    progressBar.style.width = `${(pageNum / pdf.numPages) * 100}%`;
                    
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    extractedText += pageText + '\n';
                    
                    // Pequeña pausa para mostrar progreso
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Ocultar progreso
                document.getElementById('pdfConversion').style.display = 'none';
                
                // Mostrar vista previa
                mostrarVistaPreviaPDF(extractedText);
                
            } catch (error) {
                console.error('Error procesando PDF:', error);
                alert('Error al procesar el PDF. Intenta con otro archivo.');
                document.getElementById('pdfConversion').style.display = 'none';
            }
        }

        function mostrarVistaPreviaPDF(texto) {
            const preview = document.getElementById('pdfPreview');
            const content = document.getElementById('pdfContent');
            
            // Limitar texto para vista previa
            const previewText = texto.substring(0, 1000) + (texto.length > 1000 ? '...' : '');
            content.innerHTML = `<pre style="font-size: 12px; white-space: pre-wrap;">${previewText}</pre>`;
            
            preview.style.display = 'block';
            pdfData = texto;
        }

        function convertirPDFaExcel() {
            if (!pdfData || !currentFile) {
                alert('No hay datos PDF para convertir');
                return;
            }
            
            try {
                // Convertir texto a estructura de datos
                const lineas = pdfData.split('\n').filter(line => line.trim());
                
                // Buscar patrones de tabla (filas con múltiples columnas)
                const datos = [];
                const headers = ['Producto', 'Precio', 'Marca', 'Canal']; // Headers por defecto
                
                lineas.forEach((linea, index) => {
                    // Dividir por espacios múltiples o tabs
                    const columnas = linea.split(/\s+/).filter(col => col.trim());
                    
                    if (columnas.length >= 2) {
                        const fila = {
                            nombre: columnas[0] || `Producto ${index + 1}`,
                            precio_base: parseFloat(columnas[1]) || 0,
                            marca: columnas[2] || 'Sin marca',
                            canal: columnas[3] || 'General'
                        };
                        datos.push(fila);
                    }
                });
                
                // Crear archivo Excel
                const ws = XLSX.utils.json_to_sheet(datos);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Productos");
                
                // Convertir a blob y crear archivo
                const excelBuffer = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
                const blob = new Blob([excelBuffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                
                // Crear archivo para subir
                const excelFile = new File([blob], currentFile.name.replace('.pdf', '.xlsx'), {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                // Ocultar vista previa
                document.getElementById('pdfPreview').style.display = 'none';
                
                // Subir archivo convertido
                subirArchivo(excelFile);
                
            } catch (error) {
                console.error('Error convirtiendo PDF:', error);
                alert('Error al convertir PDF. Intenta subir el archivo original.');
            }
        }

        function subirArchivo(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.mensaje) {
                    alert('✅ ' + data.mensaje);
                    location.reload(); // Recargar para mostrar productos
                } else {
                    alert('❌ Error: ' + (data.detail || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error al subir archivo');
            });
        }

        // Filtros
        document.getElementById('filtroCanal').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroMarca').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroAlertas').addEventListener('change', aplicarFiltros);

        function aplicarFiltros() {
            const canal = document.getElementById('filtroCanal').value;
            const marca = document.getElementById('filtroMarca').value;
            const alertas = document.getElementById('filtroAlertas').checked;
            
            const filas = document.querySelectorAll('.producto-row');
            
            filas.forEach(fila => {
                let mostrar = true;
                
                if (canal && fila.dataset.canal !== canal) mostrar = false;
                if (marca && fila.dataset.marca !== marca) mostrar = false;
                if (alertas && fila.dataset.alertas !== 'true') mostrar = false;
                
                fila.style.display = mostrar ? '' : 'none';
            });
        }

        function exportarCSV() {
            window.location.href = '/export/csv';
        }

        function analizarOpenAI() {
            fetch('/api/analisis-openai')
            .then(response => response.json())
            .then(data => {
                alert('🧠 ' + data.mensaje);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error al analizar con OpenAI');
            });
        }

        function limpiarProductos() {
            if (confirm('¿Estás seguro de que quieres limpiar todos los productos?')) {
                // Aquí podrías hacer una llamada al backend para limpiar
                location.reload();
            }
        }
    </script>
</body>
</html> 